name: Reusable Rollback

on:
  workflow_call:
    inputs:
      service-name:
        description: 'Service name for Docker image tagging'
        required: false
        type: string
        default: '${{ github.event.repository.name }}'
      registry-org:
        description: 'Registry organization/namespace (e.g., ghcr.io/now-start)'
        required: false
        type: string
        default: 'ghcr.io/now-start'
    secrets:
      registry-password:
        description: 'Registry password/token'
        required: true

jobs:
  rollback:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for gh cli context)
        uses: actions/checkout@v4

      - name: Get last stable release
        id: last_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LATEST_INFO=$(gh release list --limit 1 --json tagName,isPrerelease \
            --jq '.[0] | "\(.tagName)|\(.isPrerelease)"')
          IFS='|' read -r LATEST_TAG LATEST_IS_PRERELEASE <<< "$LATEST_INFO"

          if [ "$LATEST_IS_PRERELEASE" = "true" ]; then
            LAST_RELEASE=$(gh release list --exclude-pre-releases --limit 1 --json tagName \
              --jq '.[0].tagName')
          else
            LAST_RELEASE=$(gh release list --exclude-pre-releases --limit 2 --json tagName \
              --jq '.[1].tagName')
          fi

          if [ -z "$LAST_RELEASE" ]; then
            echo "âŒ No stable release found"
            exit 1
          fi

          echo "last=$LAST_RELEASE" >> $GITHUB_OUTPUT
          echo "âœ… Last stable release: $LAST_RELEASE"

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.registry-password }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Retag last stable image as latest
        run: |
          IMAGE_NAME="${{ inputs.registry-org }}/${{ inputs.service-name }}"
          VERSION="${{ steps.last_release.outputs.last }}"
          # vë¡œ ì‹œìž‘í•˜ë©´ ì œê±° (ì˜ˆ: v1.2.3 -> 1.2.3)
          VERSION_CLEAN="${VERSION#v}"

          echo "ðŸ”„ Rolling back $IMAGE_NAME:$VERSION_CLEAN â†’ $IMAGE_NAME:latest"

          docker pull "$IMAGE_NAME:$VERSION_CLEAN"
          docker tag "$IMAGE_NAME:$VERSION_CLEAN" "$IMAGE_NAME:latest"
          docker push "$IMAGE_NAME:latest"

      - name: Summary
        run: |
          echo "### ðŸ” Rollback Successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Service**: \`${{ inputs.service-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Restored**: \`${{ steps.last_release.outputs.last }}\` â†’ \`latest\`" >> $GITHUB_STEP_SUMMARY
