name: Reusable Java Docker Image

on:
  workflow_call:
    inputs:
      service-name:
        description: 'Service name for Docker image tagging'
        required: false
        type: string
        default: '${{ github.event.repository.name }}'
      registry-org:
        description: 'Registry organization/namespace (e.g., ghcr.io/now-start)'
        required: false
        type: string
        default: 'ghcr.io/now-start'
      environment:
        description: 'Deployment environment (e.g., prd, dev)'
        required: false
        type: string
        default: 'prd'
      version:
        description: 'Project version (e.g., 1.2.3)'
        required: true
        type: string
      java-version:
        description: 'Java version for bootBuildImage'
        required: true
        type: string
    secrets:
      registry-password:
        description: 'Registry password/token'
        required: true

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'
          cache: 'gradle'

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build and Push Docker image
        run: |
          IMAGE_NAME="${{ inputs.registry-org }}/${{ inputs.service-name }}"
          VERSION="${{ inputs.version }}"

          if [ "${{ inputs.environment }}" = "dev" ]; then
            POINTER_TAG="dev"
          else
            POINTER_TAG="latest"
          fi

          echo "ðŸ—ï¸ Building Docker image: $IMAGE_NAME:$VERSION"
          ./gradlew bootBuildImage \
            --imageName="$IMAGE_NAME:$VERSION" \
            --build-cache \
            -Dorg.gradle.jvmargs="-Xmx2g" \
            -PBP_OCI_SOURCE="${{ github.server_url }}/${{ github.repository }}" \
            -PBP_OCI_REVISION="${{ github.sha }}"

          echo "ðŸ” Logging in to GHCR"
          echo "${{ secrets.registry-password }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          echo "ðŸš€ Pushing images"
          docker tag "$IMAGE_NAME:$VERSION" "$IMAGE_NAME:$POINTER_TAG"
          docker push "$IMAGE_NAME:$VERSION"
          docker push "$IMAGE_NAME:$POINTER_TAG"

          echo "### ðŸ³ Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "- \`$IMAGE_NAME:$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`$IMAGE_NAME:$POINTER_TAG\`" >> $GITHUB_STEP_SUMMARY

      - name: Clean up
        if: always()
        run: |
          IMAGE_NAME="${{ inputs.registry-org }}/${{ inputs.service-name }}"
          VERSION="${{ inputs.version }}"

          if [ "${{ inputs.environment }}" = "dev" ]; then
            POINTER_TAG="dev"
          else
            POINTER_TAG="latest"
          fi

          docker rmi "$IMAGE_NAME:$VERSION" || true
          docker rmi "$IMAGE_NAME:$POINTER_TAG" || true
          docker builder prune -af || true

